<!DOCTYPE html>
<html>
  <head>
    <title>GMap Toll Road Calculator POC</title>
    <script type="text/javascript" src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
    <style type="text/css">
      #map{
        height:500px;
        width: 900px;
        float: left;
      }
      #map-info {
        float: left;
        min-height: 300px;
        width: 300px;
        background: #55ACDD;
        padding: 0 20px 20px;
      }
      #map .label {
        background: rgba(255,255,255,.85);
        padding: 2px;
        border: 1px solid #444;
      }
      /* These arrows are messing up the hover */
      /* We can put the arrows in the icon to eliminate this issue. */
      /*#map .label:before {
        content: '';
        display: block;
        position: absolute;
        top: -10px;
        left: 50%;
        border-left: 5px solid transparent;
        border-right: 5px solid transparent;
        border-top: 5px solid transparent;
        border-bottom: 5px solid #444;
        transform: translateX(-50%);
      }
      #map .label.top:before {
        top: auto;
        border-left: 5px solid transparent;
        border-right: 5px solid transparent;
        border-bottom: 5px solid transparent;
        border-top: 5px solid #444;
        bottom: -10px;
      }*/
    </style>
  </head>
  <body>
    <h1>GMaps Toll Road Calculator POC</h1>
    <div class="map" id="map"></div>
    <div class="map-info" id="map-info">
      <h2>Toll Info</h2>
      <div class="start"><strong>Start</strong>: <span></span></div>
      <div class="exit"><strong>Exit</strong>: <span></span></div>
    </div>
    <script type="text/javascript">
      var toll_calc = {
        settings: {  // -- Useful items to keep track of for the rest of the app
          step:  0,  // help determine if we are working on start or end point
          start: {}, // Starting point for the users selected route
          end:   {}, // Ending point for the users selected route
          directionsService: {},
          directionsDisplay: {}, // (to ensure zoom is respected) preserveViewport: true
          mapOptions: {},
          map: {},
          center: {},
          markers: {},
          orig_start: {},
          orig_end: {}
        },
        
        initialize: function() {
          this.settings.center = new google.maps.LatLng(38.945898, -77.316963);
          this.settings.mapOptions = {
            center: this.settings.center,
            zoom: 12,
            //minZoom: 12,
            //maxZoom: 15
          };
          this.settings.map = new google.maps.Map(document.getElementById("map"), this.settings.mapOptions);
          this.settings.directionsService = new google.maps.DirectionsService;
          this.settings.directionsDisplay = new google.maps.DirectionsRenderer({
            map: this.settings.map, 
            suppressMarkers: true, 
            polylineOptions: {
              strokeColor: "#a61aad",
              strokeWeight: 8,
              strokeOpacity: .75
            },
            preserveViewport: true
          }); // (to ensure zoom is respected) preserveViewport: true
          /*this.settings.mapOptions = {
            center: this.settings.center,
            zoom: 12,
            minZoom: 12,
            maxZoom: 15
          };
          this.settings.map = new google.maps.Map(document.getElementById("map"), this.settings.mapOptions);*/
          this.settings.directionsDisplay.setMap(this.settings.map);
          
          this.calcRoute(); // calculate default route

          // Uncomment to show traffic layer
          //var trafficLayer = new google.maps.TrafficLayer();
          //trafficLayer.setMap(map);
          
          // Load markerwithlabels.js file
          // This script needs to load after google has been initialized
          var toll_calc = this;
          $.getScript('/toll_rd_calc/tollroad_libs/markerwithlabels/markerwithlabels.js', function( data, textStatus, jqxhr ) {
            toll_calc.settings.markers = toll_calc.addMarkers();
            toll_calc.addEvents();
          });
          
        },
        
        // Set up the route.
        calcRoute: function() {
          
          var start = this.settings.orig_start = new google.maps.LatLng(38.933463, -77.212364);
          var end   = this.settings.orig_end   = new google.maps.LatLng(38.966072, -77.430008);
          
          // Get start position
          if (this.settings.start.hasOwnProperty('position') &&
              this.settings.end.hasOwnProperty('position')) {
            this.settings.directionsDisplay.setDirections({routes: []});
            start = new google.maps.LatLng(this.settings.start.position.H, this.settings.start.position.L);
            end   = new google.maps.LatLng(this.settings.end.position.H, this.settings.end.position.L);
          }
          var request = {
            origin: start,
            destination: end,
            travelMode: google.maps.TravelMode.DRIVING
          };
          var toll_calc = this;

          this.settings.directionsService.route(request, function(result, status) {
            console.log('Setting directions');
            console.log(start);
            console.log(end);
            console.log(result);
            if (status == google.maps.DirectionsStatus.OK) {
              toll_calc.settings.directionsDisplay.setDirections(result);
            }
          });
        },
        
        // Add click events handling
        //  @TODO add first clicked to start point,
        //    and last to the end point.
        addEvents: function() {
          var markerImgs = this.getMarkerImgs();
          var markers    = this.settings.markers; 
          var toll_calc  = this; // remember this forever!

          for (var i in markers) {
            // Handle click of marker
            google.maps.event.addListener(markers[i], "click", function (e) {
              if (!(toll_calc.settings.step % 2)) { // starting point
                $('#map-info .exit span').text('');
                $('#map-info .start span').text(this.labelContent);
                toll_calc.settings.step++;
                toll_calc.settings.start = this; // we need to remember the start for calcRoute later
              } 
              else { // exit point
                if (this.labelContent != $('#map-info .start span').text()) {
                  $('#map-info .exit span').text(this.labelContent);
                  toll_calc.settings.step++;
                  toll_calc.settings.end = this; // we need to remember the end for calcRoute later
                  toll_calc.calcRoute();         // calculate new route path
                }
              }
            });
            // Handle hover of marker
            //http://stackoverflow.com/questions/8198635/change-marker-icon-on-mouseover-google-maps-v3
            google.maps.event.addListener(markers[i], 'mouseover', function() {
              this.setIcon(markerImgs['hover']);
            });
            google.maps.event.addListener(markers[i], 'mouseout', function() {
              this.setIcon(markerImgs['default']);
            });
          }
        },
        
        // Return an object of all marker images
        getMarkerImgs: function() {
          var markerImgs = {};
          markerImgs['default'] = {
            url: 'Marker.png',
            size: new google.maps.Size(20, 20),   // This marker is 20 pixels wide by 20 pixels high.
            origin: new google.maps.Point(0, 0),  // The origin for this image is (0, 0).
            anchor: new google.maps.Point(10, 10) // The anchor for this image is the center the image. 
          };
          markerImgs['hover'] = {
            url: 'MarkerHover.png',
            size: new google.maps.Size(20, 20),   // This marker is 20 pixels wide by 20 pixels high.
            origin: new google.maps.Point(0, 0),  // The origin for this image is (0, 0).
            anchor: new google.maps.Point(10, 10) // The anchor for this image is the center the image.
          };
          return markerImgs;
        },
        
        // Add all markers to the map
        //  @TODO add arrow endpoint markers
        addMarkers: function() {
          var markers = {};
          var images = this.getMarkerImgs();

          markers['markerStart'] = new MarkerWithLabel({ // start
              position: new google.maps.LatLng(38.932311, -77.213286),
              map: this.settings.map,
              icon: images['default'],
              labelID: 'markerStart',
              labelContent: 'Continue to/from 267',
              labelClass: "label bot lbl-start",
              labelInForeground: true,
              labelAnchor: new google.maps.Point(56, -15),
          });
          markers['markerSpringHill'] = new MarkerWithLabel({ // Spring hill rd exit
              position: new google.maps.LatLng(38.933838, -77.233125),
              map: this.settings.map,
              icon: images['default'],
              labelID: 'markerSpringHill',
              labelContent: 'Spring Hill Rd.',
              labelClass: "label top lbl-springhill",
              labelInForeground: true,
              labelAnchor: new google.maps.Point(37, 33),
          });
          markers['markerLeesburgPike'] = new MarkerWithLabel({ // Leesburg Pike exit
              position: new google.maps.LatLng(38.934205, -77.246709),
              map: this.settings.map,
              icon: images['default'],
              labelID: 'markerLeesburgPike',
              labelContent: 'Leesburg Pike',
              labelClass: "label bot lbl-leesburg",
              labelInForeground: true,
              labelAnchor: new google.maps.Point(37, -15)
          });
          markers['markerWolftrap'] = new MarkerWithLabel({ // Wolftrap exit
              position: new google.maps.LatLng(38.936575, -77.267609),
              map: this.settings.map,
              icon: images['default'],
              labelID: 'markerWolftrap',
              labelContent: 'Wolftrap Rd.',
              labelClass: "label top lbl-wolftrap",
              labelInForeground: true,
              labelAnchor: new google.maps.Point(33, 33)
          });
          markers['markerHunterMill'] = new MarkerWithLabel({ // Hunter Mill exit
              position: new google.maps.LatLng(38.947811, -77.311951),
              map: this.settings.map,
              icon: images['default'],
              labelID: 'markerHunterMill',
              labelContent: 'Huntermill Rd.',
              labelClass: "label top lbl-huntermill",
              labelInForeground: true,
              labelAnchor: new google.maps.Point(38, 33)
          });
          markers['markerWiehle'] = new MarkerWithLabel({ // Wiehle Ave exit
              position: new google.maps.LatLng(38.946989, -77.337679),
              map: this.settings.map,
              icon: images['default'],
              labelID: 'markerWiehle',
              labelContent: 'Wiehle Ave.',
              labelClass: "label bot lbl-wiehle",
              labelInForeground: true,
              labelAnchor: new google.maps.Point(32, -15)
          });
          markers['markerReston'] = new MarkerWithLabel({ // Reston Parkway exit
              position: new google.maps.LatLng(38.952225, -77.356310),
              map: this.settings.map,
              icon: images['default'],
              labelID: 'markerReston',
              labelContent: 'Reston Parkway',
              labelClass: "label top lbl-reston",
              labelInForeground: true,
              labelAnchor: new google.maps.Point(44, 33)
          });
          markers['markerFairfax'] = new MarkerWithLabel({ // Fairfax Parkway exit
              position: new google.maps.LatLng(38.953192, -77.374011),
              map: this.settings.map,
              icon: images['default'],
              labelID: 'markerFairfax',
              labelContent: 'Fairfax Parkway',
              labelClass: "label bot lbl-fairfax",
              labelInForeground: true,
              labelAnchor: new google.maps.Point(41, -15),
          });
          markers['markerMonroe'] = new MarkerWithLabel({ // Monroe St. exit
              position: new google.maps.LatLng(38.953256, -77.388697),
              map: this.settings.map,
              icon: images['default'],
              labelID: 'markerMonroe',
              labelContent: 'Monroe St.',
              labelClass: "label top lbl-monroe",
              labelInForeground: true,
              labelAnchor: new google.maps.Point(29, 33)
          });
          markers['markerCenterville'] = new MarkerWithLabel({ // Centerville Rd. exit
              position: new google.maps.LatLng(38.956835, -77.404270),
              map: this.settings.map,
              icon: images['default'],
              labelID: 'markerCenterville',
              labelContent: 'Centerville Rd.',
              labelClass: "label bot lbl-centerville",
              labelInForeground: true,
              labelAnchor: new google.maps.Point(38, -15)
          });
          markers['markerSully'] = new MarkerWithLabel({ // Sully Rd. exit
              position: new google.maps.LatLng(38.962501, -77.423039),
              map: this.settings.map,
              icon: images['default'],
              labelID: 'markerSully',
              labelContent: 'Sully Rd.',
              labelClass: "label bot lbl-sully",
              labelInForeground: true,
              labelAnchor: new google.maps.Point(24, -15)
          });
          markers['markerEnd'] = new MarkerWithLabel({ // On to Dulles Greenway
              position: new google.maps.LatLng(38.965296, -77.429219),
              map: this.settings.map,
              icon: images['default'],
              labelID: 'markerEnd',
              labelContent: 'Continue to/from Dulles Greenway',
              labelClass: "label top lbl-end",
              labelInForeground: true,
              labelAnchor: new google.maps.Point(88, 33)
          });
          return markers;
        }
      };

    </script>
    <script 
      src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBmJ2morRvylFgmS-bcKsCPeklcxJ2lZTg&callback=toll_calc.initialize">
    </script>
  </body>
</html>
