<!DOCTYPE html>
<html>
  <head>
    <title>GMap Toll Road Calculator POC</title>
    <script type="text/javascript" src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap.min.css">
    <style type="text/css">
      #map{
        height:500px;
        width: 900px;
        float: left;
      }
      #map-info {
        float: left;
        width: 300px;
        background: #84AED5;
        border: 1px solid #55ACDD;
        padding: 0 20px 20px;
        margin-left: 5px;
      }
      #map-info .alert {
        padding: 7px;
      }
      #map-info .messages {
        margin-bottom: 0;
        margin-top: 1em;
      }
      #map-info .messages ul {
        padding-left: 15px;
      }
      #map-info #axles-form {
        margin-top: 1em;
      }
      #map-info .toll {
        margin-top: 1em;
      }
      #map .marker-label {
        background: rgba(255,255,255,.85);
        padding: 2px;
        border: 1px solid #444;
        font-family: "Helvetica Neue",Helvetica,Arial,sans-serif;
        /*font-size: 15px;*/
      }
    </style>
  </head>
  <body>
    <h1>Dulles Toll Road Calculator</h1>
    
    <!-- Container for map -->
    <div class="map" id="map"></div>
    
    <!-- Block for info display -->
    <div class="map-info" id="map-info">
      <h4>Dulles Toll Road Calculator</h4>
      <div class="start"><strong>Start</strong>: <span></span></div>
      <div class="end"><strong>Exit</strong>: <span></span></div>
      <div class="axles">
        <form id="axles-form">
          <div><label><input class="axle-check" type="checkbox" name="2axles" value="2" checked="checked"> 2 Axles</label></div>
          <div><label><input class="axle-check" type="checkbox" name="3axles" value="3"> 3 Axles</label></div>
          <div><label><input class="axle-check" type="checkbox" name="4axles" value="4"> 4 Axles</label></div>
          <div><label><input class="axle-check" type="checkbox" name="5axles" value="5"> 5 Axles</label></div>
          <div><label><input class="axle-check" type="checkbox" name="6axles" value="6"> 6+ Axles</label></div>
        </form>
      </div>
      <div class="toll"><strong>Toll</strong>: <span></span></div>
      <div class="messages alert alert-danger"></div>
    </div>
    
    <script type="text/javascript">
      var tollCalc = {
        settings: { // ---> Useful items to keep track of for the rest of the app
          step:  0,       // help determine if we are working on start or end point
          start: {},      // Starting point for the users selected route
          end:   {},      // Ending point for the users selected route
          directionsService: {}, // service to get directions from (google obj)
          directionsDisplay: {}, // (to ensure zoom is respected) preserveViewport: true
          mapOptions: {}, // map options (obviously)
          map: {},        // google map obj
          center: {},     // center point of the map
          markers: {},    // A list of markers
          orig_start: {}, // original start point
          orig_end: {},   // original end point
          heading: '',    // keep track of the heading the user has selected (east / west)
          messages: [],   // Any messages that should be shown to user should be pushed here
          messageCont: $('#map-info .messages').hide() // Container for the messages
        },
        
        initialize: function() {
          this.settings.center = new google.maps.LatLng(38.945898, -77.316963);
          this.settings.mapOptions = {
            center: this.settings.center,
            zoom: 12,
            minZoom: 12,
            maxZoom: 14
          };
          this.settings.map = new google.maps.Map(document.getElementById("map"), this.settings.mapOptions);
          this.settings.directionsService = new google.maps.DirectionsService;
          this.settings.directionsDisplay = new google.maps.DirectionsRenderer({
            map: this.settings.map, 
            suppressMarkers: true, 
            polylineOptions: {
              strokeColor: "#a61aad",
              strokeWeight: 8,
              strokeOpacity: .75
            },
            preserveViewport: true
          }); // (to ensure zoom is respected) preserveViewport: true
          
          this.settings.directionsDisplay.setMap(this.settings.map);
          this.calcRoute(); // calculate default route

          // Uncomment to show traffic layer - May be moved into an enableable function later
          //var trafficLayer = new google.maps.TrafficLayer();
          //trafficLayer.setMap(map);
          
          // Load markerwithlabels.js file
          // This script needs to load after google has been initialized
          var tollCalc = this;
          $.getScript('/toll_rd_calc/tollroad_libs/markerwithlabels/markerwithlabels.js', function( data, textStatus, jqxhr ) {
            tollCalc.settings.markers = tollCalc.addMarkers();
            tollCalc.addEvents();
          });
          
          this.initCheckboxes();
        },
        
     
        // Set up the route.
        calcRoute: function(reset) {
          var reset = (reset) ? reset : false;
          // Start at the west side
          var start = this.settings.orig_start = new google.maps.LatLng(38.966176, -77.430888); // cont to Dulles Greenway
          var end   = this.settings.orig_end   = new google.maps.LatLng(38.931673, -77.212148); // cont. to 267
          
          // Get start position - mind the reset
          if (this.settings.start.hasOwnProperty('position') &&
              this.settings.end.hasOwnProperty('position') && !reset) {
            
            if (this.settings.heading == 'east') { // east bound
              // The route maps fine this way :)
              start = new google.maps.LatLng(this.settings.start.position.H, this.settings.start.position.L);
              end   = new google.maps.LatLng(this.settings.end.position.H, this.settings.end.position.L);
            }
            else { // west bound
              // When headed west, the directions need to be reversed to keep the route on the right path
              //  If and when we handle the east and west bound traffic differently (adding new route markers etc.) this 
              //  can be updated (and or removed)
              end   = new google.maps.LatLng(this.settings.start.position.H, this.settings.start.position.L); // note the start is sent into end 
              start = new google.maps.LatLng(this.settings.end.position.H, this.settings.end.position.L);     //  and vs. versus.
            }
          }
          var request = {
            origin: start,
            destination: end,
            travelMode: google.maps.TravelMode.DRIVING
          };
          var tollCalc = this;

          this.settings.directionsService.route(request, function(result, status) {
            if (status == google.maps.DirectionsStatus.OK) {
              tollCalc.settings.directionsDisplay.setDirections(result);
            }
          });
        },


        // Set the user's proposed heading
        setHeading: function(marker) {
          if (this.settings.start.labelNo > marker.labelNo) { // east bound
            this.settings.heading = 'east';
          }
          else {
            this.settings.heading = 'west';
          }
        },


        // Ensure the route selected is a valid one.
        verifyRoute: function(marker) {
          var start = this.settings.start;
          var end   = marker;
          var msgs  = [];

          // Set the heading given the endpoint (marker)
          this.setHeading(marker);

          // I want to print starting point messages
          //  before printing ending point messages.
          
          // Starting point msgs
          if (this.settings.heading === 'east') { // East
            // Nothing here yet...
          }
          if (this.settings.heading === 'west') { // East
            if (start.labelNo == 4) {
              msgs.push('No entry Westbound at '+start.labelContent);
            }
          }
          
          // Ending point msgs
          if (this.settings.heading === 'east') { // East
            if (end.labelNo == 4) {
              msgs.push('No exit Eastbound at '+end.labelContent);
            }
          }
          if (this.settings.heading === 'west') { // East
            if (end.labelNo == 9) { // Monroe
              msgs.push('No exit Westbound at '+end.labelContent);
            }
          }
          
          if (msgs.length) {
            this.settings.messages = msgs;
            this.updateMessages();
            return false;
          }

          return true;
        },


        // Update warning messages
        updateMessages: function(reset) {
          var reset = (reset) ? true : false;
          if (!reset) {
            var content = '';
            var wrapper = (this.settings.messages.length > 1) ? 'li' : 'div';
            
            // Determine wrapper
            if (this.settings.messages.length > 1) {
              wrapper = 'li';
              content += '<ul>';
            }
            else {
              wrapper = 'div';
            }
            
            // Add messages to the content
            for (var i in this.settings.messages) {
              content += '<'+wrapper+' class="message">'+this.settings.messages[i]+'</'+wrapper+'>';
            }
            
            if (this.settings.messages.length > 1) content += '</ul>'; // close the ul
            this.settings.messageCont.html(content).show(); // add messages to screen and show them
          }
          else {
            this.settings.messageCont.html('').hide();
          }
        },


        // elem should either be 'start', 'end', or 'toll'
        //  text is the content to show
        //  Pass nothing or 'true' to reset
        setInfoText: function(elem, text, reset) {
          elem = (elem) ? elem : false;
          if (!elem || reset) { //resetting
            $('#map-info .start span').text('');
            $('#map-info .end span').text('');
            $('#map-info .toll span').text('');
          }
          if (elem) {
            if (elem === 'start') {
              $('#map-info .end span').text('');
              $('#map-info .start span').text(text);
            }
            else if (elem === 'end') {
              $('#map-info .end span').text(text);
            }
            else if (elem === 'toll') {
              text = Number(text).toFixed(2);           // covert toll to decimal w 2 digits
              $('#map-info .toll span').text('$'+text); // set toll in window
            }
          }
        },
        
        fun: function() {
          alert('Click');
        },

        // Add click events handling
        addEvents: function() {
          var markerImgs = this.getMarkerImgs();
          var markers    = this.settings.markers; 
          var tollCalc   = this;  // remember this forever!
          var infoWindow = new google.maps.InfoWindow({
            content:'<div class="marker-window">\
                       <h5>Is this your starting point or end point?</h5>\
                       <button type="button" class="btn btn-primary" onclick="tollCalc.fun()">Start</button>\
                       <button type="button" class="btn btn-danger" onclick="tollCalc.fun()">End</button>\
                     </div>'
          }); // End info window content
          
          for (var i in markers) {
            // Handle click of marker
            google.maps.event.addListener(markers[i], "click", function (e) {
              
              infoWindow.open(tollCalc.settings.map, this);
              
              if (this.labelID != 'markerMain') {     // no changes on click of marker main - you can't exit at main toll plaza
                if (!(tollCalc.settings.step % 2)) { // starting point
                  tollCalc.setInfoText('start', this.labelContent, true);
                  tollCalc.resetMarkers();
                  tollCalc.updateMessages(true);
                  tollCalc.settings.step++;
                  tollCalc.settings.start = this; // we need to remember the start for calcRoute later
                  tollCalc.selectMarker(this);    // Update label
                } 
                else { // exit point
                  // Make sure user is not entering at the same spot as they are exiting
                  if (this.labelID != tollCalc.settings.start.labelID) {
                    // We need to verify the route before continuing
                    if (tollCalc.verifyRoute(this)) {
                      tollCalc.setInfoText('end', this.labelContent);
                      tollCalc.settings.end = this; // we need to remember the end for calcRoute later
                      tollCalc.calcRoute();         // calculate new route path
                      tollCalc.calcToll();          // calculate the toll fee
                      tollCalc.selectMarker(this);  // Update label
                    }
                    else {
                      tollCalc.setInfoText();  // reset text
                      tollCalc.resetMarkers(); // reset map
                    }
                    tollCalc.settings.step++;
                  }
                }
              }
            });

            // Handle hover of marker
            google.maps.event.addListener(markers[i], 'mouseover', function() {
              if (this.labelID != 'markerMain') { // no effects
                this.setIcon(markerImgs['hover']);
              }
            });
            google.maps.event.addListener(markers[i], 'mouseout', function() {
              // Don't reset main toll plaza marker, or any marker that is selected as part
              //  of the user's expected route
              if (this.labelID != 'markerMain' && (this.labelClass.search('selected') < 0)) {
                this.setIcon(markerImgs['default']);
              }
            });
          }
        },


        calcToll: function() {
          var heading = this.settings.heading;       // Users heading (E/W)
          var startNo = this.settings.start.labelNo; // The users entry point
          var endNo   = this.settings.end.labelNo;   // The point that they are exiting at
          var toll    = 0;                           // cumulative toll fee
          
          // here we use the # of axles to select price from tollMap
          var axles   = Number($('.axle-check:checked').val()) - 2; 
          
          // Get the toll price map (based on # axles)
          var tollMap = this.tollMap();
          
          // Do they pass through main toll plaza? - EB || WB
          if ((startNo >= 3 && endNo < 3) || (startNo <= 2 && endNo > 2)) {
            toll += tollMap['main'][axles];
          }
          
          // Heading --East--
          if (heading == 'east') {
            // Entry points w/out tolls
            if (startNo != 3 && startNo != 4) { // No entry toll on Wolftrap or Leesburg
              toll += tollMap[startNo][axles];
            }
            if (endNo != 9) { // No exit toll at Monroe
              toll += tollMap[endNo][axles];
            }
          }
          
          // Heading --West--
          if (heading == 'west') {
            // Entry points w/out tolls
            if (startNo != 3 && startNo != 9) { // No entry toll on Wolftrap or Monroe
              toll += tollMap[startNo][axles];
            }
            if (endNo != 3 && endNo != 4) { // No exit toll on Wolftrap or Leesburg
              toll += tollMap[endNo][axles];
            }
          }
          this.setInfoText('toll', toll);
          //toll = Number(toll).toFixed(2);           // covert toll to decimal w 2 digits
          //$('#map-info .toll span').text('$'+toll); // set toll in window
        },


        // Get toll mapping according to # axles
        //  Maps to axle count (2, 3, 4, 5, 6) fee
        //  tollMap obj Keyed by settings.(start/end point).LabelNo
        tollMap: function(dir) {
          var tollMap = {};
          tollMap[12] = [0, 0, 0,   0, 0];   // Dulles Greenway
          tollMap[11] = [1, 2, 2.5, 3, 3.5]; // Sully road
          tollMap[10] = [1, 2, 2.5, 3, 3.5]; // Centerville
          tollMap[9]  = [1, 2, 2.5, 3, 3.5]; // Monroe
          tollMap[8]  = [1, 2, 2.5, 3, 3.5]; // Fairfax
          tollMap[7]  = [1, 2, 2.5, 3, 3.5]; // Reston
          tollMap[6]  = [1, 2, 2.5, 3, 3.5]; // Wiehle
          tollMap[5]  = [1, 2, 2.5, 3, 3.5]; // Huntermill
          tollMap[4]  = [0, 0, 0,   0, 0];   // Wolftrap
          tollMap[3]  = [1, 2, 2.5, 3, 3.5]; // Leesburg
          tollMap[2]  = [1, 2, 2.5, 3, 3.5]; // Springhill
          tollMap[1]  = [0, 0, 0,   0, 0];   // On to 267
          
          // Main toll plaza
          tollMap['main'] = [2.5, 5, 6.25, 7.5, 8.75]; // Not an exit or entrance 
          return tollMap;
        },


        // Update the marker class
        selectMarker: function(marker) {
          var markerImgs = this.getMarkerImgs();
          marker.set('labelClass', marker.labelClass+' selected');
          marker.setIcon(markerImgs['hover']);
        },


        // Reset markers as needed
        resetMarkers: function() {
          var markerImgs = this.getMarkerImgs();
          for (var i in this.settings.markers) {
            if (this.settings.markers[i].labelID != 'markerMain') {
              if (this.settings.markers[i].labelClass.search('selected') > 0) {
                this.settings.markers[i].set('labelClass', this.settings.markers[i].labelClass.slice(0, -9));
              }
              this.settings.markers[i].setIcon(markerImgs['default']);
            }
          }
          this.calcRoute(true);
        },


        // Return an object of all marker images
        getMarkerImgs: function() {
          var markerImgs = {};
          markerImgs['default'] = {
            url: 'Marker.png',
            size: new google.maps.Size(20, 20),   // This marker is 20 pixels wide by 20 pixels high.
            origin: new google.maps.Point(0, 0),  // The origin for this image is (0, 0).
            anchor: new google.maps.Point(10, 10) // The anchor for this image is the center the image. 
          };
          markerImgs['hover'] = {
            url: 'MarkerHover.png',
            size: new google.maps.Size(20, 20),   // This marker is 20 pixels wide by 20 pixels high.
            origin: new google.maps.Point(0, 0),  // The origin for this image is (0, 0).
            anchor: new google.maps.Point(10, 10) // The anchor for this image is the center the image.
          };
          markerImgs['main'] = {
            url: 'MarkerMain.png',
            size: new google.maps.Size(13, 20),   // This marker is 20 pixels wide by 20 pixels high.
            origin: new google.maps.Point(0, 0),  // The origin for this image is (0, 0).
            anchor: new google.maps.Point(10, 10) // The anchor for this image is the center the image.
          };
          return markerImgs;
        },


        // Add all markers to the map
        //  @TODO add arrow endpoint markers
        addMarkers: function() {
          var markers = {};
          var images = this.getMarkerImgs();

          // markers are layed out from East most (1) to West most (12)
          markers['markerStart'] = new MarkerWithLabel({ // Start
              position: new google.maps.LatLng(38.931673, -77.212148),
              map: this.settings.map,
              icon: images['default'],
              labelNo: 1,
              labelID: 'markerStart',
              labelContent: 'Continue to/from 267',
              labelClass: "marker-label bot lbl-start",
              labelInForeground: true,
              labelAnchor: new google.maps.Point(56, -15),
          });
          markers['markerSpringHill'] = new MarkerWithLabel({ // Spring hill rd exit
              position: new google.maps.LatLng(38.933476, -77.233097),
              map: this.settings.map,
              icon: images['default'],
              labelNo: 2,
              labelID: 'markerSpringHill',
              labelContent: 'Spring Hill Rd.',
              labelClass: "marker-label top lbl-springhill",
              labelInForeground: true,
              labelAnchor: new google.maps.Point(37, 33),
          });
          markers['markerMain'] = new MarkerWithLabel({ // Main toll plaza
              position: new google.maps.LatLng(38.934199, -77.238835),
              map: this.settings.map,
              icon: images['main'],
              labelID: 'markerMain'
          });
          markers['markerLeesburgPike'] = new MarkerWithLabel({ // Leesburg Pike exit
              position: new google.maps.LatLng(38.933952, -77.246473),
              map: this.settings.map,
              icon: images['default'],
              labelNo: 3,
              labelID: 'markerLeesburgPike',
              labelContent: 'Leesburg Pike',
              labelClass: "marker-label bot lbl-leesburg",
              labelInForeground: true,
              labelAnchor: new google.maps.Point(37, -15)
          });
          markers['markerWolftrap'] = new MarkerWithLabel({ // Wolftrap exit
              position: new google.maps.LatLng(38.936173, -77.267612),
              map: this.settings.map,
              icon: images['default'],
              labelNo: 4,
              labelID: 'markerWolftrap',
              labelContent: 'Wolftrap Rd.',
              labelClass: "marker-label top lbl-wolftrap",
              labelInForeground: true,
              labelAnchor: new google.maps.Point(33, 33)
          });
          markers['markerHunterMill'] = new MarkerWithLabel({ // Hunter Mill exit
              position: new google.maps.LatLng(38.947480, -77.311970),
              map: this.settings.map,
              icon: images['default'],
              labelNo: 5,
              labelID: 'markerHunterMill',
              labelContent: 'Huntermill Rd.',
              labelClass: "marker-label top lbl-huntermill",
              labelInForeground: true,
              labelAnchor: new google.maps.Point(38, 33)
          });
          markers['markerWiehle'] = new MarkerWithLabel({ // Wiehle Ave exit
              position: new google.maps.LatLng(38.946697, -77.337822),
              map: this.settings.map,
              icon: images['default'],
              labelNo: 6,
              labelID: 'markerWiehle',
              labelContent: 'Wiehle Ave.',
              labelClass: "marker-label bot lbl-wiehle",
              labelInForeground: true,
              labelAnchor: new google.maps.Point(32, -15)
          });
          markers['markerReston'] = new MarkerWithLabel({ // Reston Parkway exit
              position: new google.maps.LatLng(38.951924, -77.356179),
              map: this.settings.map,
              icon: images['default'],
              labelNo: 7,
              labelID: 'markerReston',
              labelContent: 'Reston Parkway',
              labelClass: "marker-label top lbl-reston",
              labelInForeground: true,
              labelAnchor: new google.maps.Point(44, 33)
          });
          markers['markerFairfax'] = new MarkerWithLabel({ // Fairfax Parkway exit
              position: new google.maps.LatLng(38.952877, -77.374265),
              map: this.settings.map,
              icon: images['default'],
              labelNo: 8,
              labelID: 'markerFairfax',
              labelContent: 'Fairfax Parkway',
              labelClass: "marker-label bot lbl-fairfax",
              labelInForeground: true,
              labelAnchor: new google.maps.Point(41, -15),
          });
          markers['markerMonroe'] = new MarkerWithLabel({ // Monroe St. exit
              position: new google.maps.LatLng(38.952984, -77.388808),
              map: this.settings.map,
              icon: images['default'],
              labelNo: 9,
              labelID: 'markerMonroe',
              labelContent: 'Monroe St.',
              labelClass: "marker-label top lbl-monroe",
              labelInForeground: true,
              labelAnchor: new google.maps.Point(29, 33)
          });
          markers['markerCenterville'] = new MarkerWithLabel({ // Centerville Rd. exit
              position: new google.maps.LatLng(38.956560, -77.404512),
              map: this.settings.map,
              icon: images['default'],
              labelNo: 10,
              labelID: 'markerCenterville',
              labelContent: 'Centerville Rd.',
              labelClass: "marker-label bot lbl-centerville",
              labelInForeground: true,
              labelAnchor: new google.maps.Point(38, -15)
          });
          markers['markerSully'] = new MarkerWithLabel({ // Sully Rd. exit
              position: new google.maps.LatLng(38.962125, -77.422574),
              map: this.settings.map,
              icon: images['default'],
              labelNo: 11,
              labelID: 'markerSully',
              labelContent: 'Sully Rd.',
              labelClass: "marker-label bot lbl-sully",
              labelInForeground: true,
              labelAnchor: new google.maps.Point(24, -15)
          });
          markers['markerEnd'] = new MarkerWithLabel({ // On to Dulles Greenway
              position: new google.maps.LatLng(38.966176, -77.430888),
              map: this.settings.map,
              icon: images['default'],
              labelNo: 12,
              labelID: 'markerEnd',
              labelContent: 'Continue to/from Dulles Greenway',
              labelClass: "marker-label top lbl-end",
              labelInForeground: true,
              labelAnchor: new google.maps.Point(88, 33)
          });
          return markers;
        },


        // Ensure only one checkbox can be selected      
        initCheckboxes: function() {
          var tollCalc = this;
          $('.axle-check').click(function() {
            $('.axle-check').prop("checked", false);
            $(this).prop("checked", true);

            // Must have a position on start and end to calcToll
            if (tollCalc.settings.start.hasOwnProperty('position') &&
                tollCalc.settings.end.hasOwnProperty('position')) {
              tollCalc.calcToll();      
            }
          });
        }
      };
      

    </script>
    <script 
      src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBmJ2morRvylFgmS-bcKsCPeklcxJ2lZTg&callback=tollCalc.initialize">
    </script>
  </body>
</html>
