<!DOCTYPE html>
<html>
  <head>
    <title>Dulles Toll Road Calculator</title>
    <script type="text/javascript" src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap.min.css">
    <style type="text/css">
      body {
        height: 100%;
        max-width: 1200px;
        margin: 10px auto;
      }
      #map{
        height:inherit;
        width: 800px;
        height: 500px;
        float: left;
      }
      #map-info {
        float: left;
        width: 300px;
        background: #157bc3;
        border: 1px solid #55ACDD;
        padding: 0 20px 20px;
        box-sizing: border-box;
      }
      #map-info h4 {
        margin-bottom: 1em;
      }
      #map-info h4,
      #map-info h5,
      #map-info label {
        color: white;
      }
      #map-info .alert {
        padding: 7px;
      }
      #map-info .alert-info {
        background: #fff;
        font-weight: bold;
      }
      #map-info .alert-info .start label,
      #map-info .alert-info .end label {
        min-width: 40px;
      }
      #map-info .alert-info .point {
        color: #000;
      }
      #map-info .messages {
        margin-bottom: 0;
        margin-top: .5em;
      }
      #map-info .messages ul {
        padding-left: 15px;
      }
      #map-info #axles-form {
        margin-top: .5em;
      }
      #map-info .traffic,
      #map-info .mapshow {
        float: right;
        position: relative;
        top: -2px;
        margin-left: 8px;
      }
      #map-info .btn-primary .fm,
      #map-info .mapshow {
        display: none;
      }
      #map-info .toll {
        margin: 0;
        padding: 0;
      }
      #map-info .toll span {
        padding-top: .5em;
        text-align: center;
        clear: both;
        display: block;
        margin: 0;
        color: white;
        font-weight: bold;
      }
      #map-info .sel {
        width: 100%;
        height: 34px;
        overflow: hidden;
        background: url(toll-select-bg-sml.png) no-repeat right white;
        border-radius: 5px;
        border: none;
        margin-bottom: 10px;
      }
      #map-info .sel select {
        margin-bottom: 10px;
        background: transparent;
        border: none;
        width: 100%;
        padding: 5px;
        font-size: 16px;
        line-height: 1;
        height: 34px;
        -webkit-appearance: none;
      }
      #map-info .axle-cont .sel {
        float: left;
        width: 90px;
        margin-right: 15px;
      }
      #map-info .axle-cont .sel select {
        width: 90px;
      }
      #map-info .btn-primary {
        background-color: #75d8fe;
        border: none;
        color: #333
      }
      #map-info .reset-cont {
        float: left;
      }
      #map-info .toll-et-al {
        clear: both;
      }
      #map .marker-label {
        background: rgba(255,255,255,.85);
        padding: 2px;
        border: 1px solid #444;
        font-family: "Helvetica Neue",Helvetica,Arial,sans-serif;
        white-space: nowrap;
      }
      .clearfix:after { 
         content: " ";
         display: block; 
         height: 0; 
         clear: both;
      }
      @media only screen and (max-width: 901px) {
        #map-info .toll-et-al {
          float: left;
          clear: none;
        }
        #map-info .toll span {
          margin-left: .75em;
          padding: 0;
          line-height: 34px;
        }
        #map-info .axles {
          float: left;
          margin-right: 3em;
        }
        #map-info .messages {
          margin-bottom: 0;
          margin-top: 0;
          margin-left: 1em;
        }
      }
      @media only screen and (max-width: 601px) {
        body {
          width: 100%;
        }
        #map,
        #map-info .traffic,
        #map-info .btn-reset .mp {
          display: none;
        }
        #map-info .mapshow {
          display: block;
        }
        .page-title {
          font-size: 21px;
          line-height: 30px;
        }
        .info-title {
          display: none;
        }
        #map-info .alert-info {
          margin: 1em 0; 
        }
      }
      @media only screen and (max-width: 500px) {
        #map-info .toll-et-al {
          float: none;
          clear: both;
        }
        #map-info .messages {
          margin-bottom: 0;
          margin-top: .5em;
          margin-left: 0;
        }
      }
      @media only screen and (max-width: 350px) {
        
      }
    </style>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
  </head>
  <body>
    <h1 class="page-title">Dulles Toll Road Calculator</h1>
    
    <!-- Container for map -->
    <div class="map" id="map"></div>
    
    <!-- Block for info display -->
    <div class="map-info clearfix" id="map-info">
      <h4 class="info-title">Dulles Toll Road Calculator</h4>
      <div class="exits">
        <h5>Start
          <label class="traffic">
            <input class="traffic-check" type="checkbox" name="traffic"> <span>Enable traffic</span>
          </label>
          <label class="mapshow">
            <input class="mapshow-check" type="checkbox" name="showmap"> <span>Show map</span>
          </label>  
        </h5>
        <div class="sel">
          <select class="start">
            <option value="start">Select</option>
            <option value="i267">Interstate 267</option>
            <option value="spring_hill">Spring Hill Rd.</option>
            <option value="leesburg_pike">Leesburg Pike</option>
            <option value="wolftrap_rd">Wolftrap Rd.</option>
            <option value="huntermill_rd">Huntermill Rd.</option>
            <option value="wiehle_ave">Wiehle Ave.</option>
            <option value="reston_parkway">Reston Parkway</option>
            <option value="fairfax_parkway">Fairfax Parkway</option>
            <option value="monroe_st">Monroe St.</option>
            <option value="centerville_rd">Centerville Rd.</option>
            <option value="sully_rd">Sully Rd.</option>
            <option value="dulles_greenway">Dulles Greenway</option>
          </select>
        </div>
        <h5>Exit</h5>
        <div class="sel">
          <select class="end">
            <option value="end">Select</option>
            <option value="i267">Interstate 267</option>
            <option value="spring_hill">Spring Hill Rd.</option>
            <option value="leesburg_pike">Leesburg Pike</option>
            <option value="wolftrap_rd">Wolftrap Rd.</option>
            <option value="huntermill_rd">Huntermill Rd.</option>
            <option value="wiehle_ave">Wiehle Ave.</option>
            <option value="reston_parkway">Reston Parkway</option>
            <option value="fairfax_parkway">Fairfax Parkway</option>
            <option value="monroe_st">Monroe St.</option>
            <option value="centerville_rd">Centerville Rd.</option>
            <option value="sully_rd">Sully Rd.</option>
            <option value="dulles_greenway">Dulles Greenway</option>
          </select>
        </div>
      </div>
      <div class="axle-cont">
        <h5>Axles</h5>
        <div class="sel">
          <select class="axles">
            <option value="2" selected="selected">2</option>
            <option value="3">3</option>
            <option value="4">4</option>
            <option value="5">5</option>
            <option value="6">6+</option>
          </select>
        </div>
      </div>
      <div class="reset-cont"><button class="btn btn-primary btn-reset">Reset <span class="mp">map</span><span class="fm">form</span></button></div>
      <div class="toll-et-al">
        <h3 class="toll"></h3>
        <div class="messages alert alert-danger"></div>
      </div>
    </div>
    
    <script type="text/javascript">
      var tollCalc = {
        settings: { // ---> Useful items to keep track of for the rest of the app
          step:        0,  // help determine if we are working on start or end point
          start:       {}, // Starting point for the users selected route
          end:         {}, // Ending point for the users selected route
          lastStart:   {}, // The last start of the route that was requested
          lastEnd:     {}, // The last end of the route that was requested
          directionsService: {}, // service to get directions from (google obj)
          directionsDisplay: {}, // (to ensure zoom is respected) preserveViewport: true
          mapOptions:  {}, // map options (obviously)
          map:         {}, // google map obj
          traffic:     {}, // google traffic layer
          center:      {}, // center point of the map
          markers:     {}, // A list of markers
          orig_start:  {}, // original start point
          orig_end:    {}, // original end point
          infoWindows: {}, // A set of info windows keyed by marker labelNo
          heading:     '', // keep track of the heading the user has selected (east / west)
          messages:    [], // Any messages that should be shown to user should be pushed here
          messageCont: $('#map-info .messages').hide(), // Container for the messages
          startSelect: $('#map-info select.start'), // select box for the start point
          endSelect:   $('#map-info select.end'), // select box for the end point
          axleSelect:  $('#map-info select.axles'), // Axles select box
          tollText:    $('#map-info .toll') // Text to display Toll fee
        },


        initialize: function() {
          this.settings.center = new google.maps.LatLng(38.945898, -77.316963);
          this.settings.mapOptions = {
            center: this.settings.center,
            zoom: 12,
            minZoom: 12,
            maxZoom: 15
          };
          this.settings.map = new google.maps.Map(document.getElementById("map"), this.settings.mapOptions);
          this.settings.directionsService = new google.maps.DirectionsService;
          this.setDirectionsDisplay(.75); // set the Directions display at 75% opacity
          this.settings.traffic = new google.maps.TrafficLayer(); // traffic layer

          // Load markerwithlabels.js file
          // This script needs to load after google has been initialized
          var tollCalc = this;
          $.getScript('/toll_rd_calc/tollroad_libs/markerwithlabels/markerwithlabels.js', function( data, textStatus, jqxhr ) {
            tollCalc.addMarkers();
            tollCalc.initInfoWindows();
            tollCalc.initEvents();
            tollCalc.initCheckboxes();
            tollCalc.initSelectBoxes();
            tollCalc.initResize();
            tollCalc.initBtnReset();
          });
        },


        // Allow the map and info pane to be resized.
        initResize: function() {
          var winH      = 0;
          var winHOrig  = $(window).height();
          var $map      = $('#map');
          var $info     = $('#map-info');
          var winW      = 0;
          var winWOrig  = $(window).width();
          var mapWOrig  = $map.width(); 
          var infoWOrig = $info.width();
          var tollCalc = this;
          
          // Callback to resize the map and info window
          var resize = function() {
            winW = $(window).width();
            winH = $(window).height();

            if ((mapWOrig + infoWOrig) >= (winW - 50)) {
              $map.css({'width': winW+'px', 'height': (winH / 1.75) + 'px'});
              $info.css('width', winW+'px');
            }
            else {
              $map.css({'width': '', 'height': ''});
              $info.css({'width': '', 'height': ''});
            }

            google.maps.event.trigger(tollCalc.settings.map, "resize");
            tollCalc.settings.map.setCenter(tollCalc.settings.center); 
          };
          
          resize(); // call it once to intialize it.
          $(window).resize(function() {
            resize(); 
          });
        },


        // Enable/disable traffic layer
        toggleTraffic: function(status) {
          if (status) {
            this.setDirectionsDisplay(.4);
            this.settings.traffic.setMap(this.settings.map);
          }
          else {
            this.setDirectionsDisplay(.75);
            this.settings.traffic.setMap(null);
          }
        },


        // Reset or initialise the directionsDisplay renderer
        setDirectionsDisplay: function(opacity) {
          if (this.settings.directionsDisplay.hasOwnProperty('directions')) {
            this.settings.directionsDisplay.setMap(null);
          }
          this.settings.directionsDisplay = new google.maps.DirectionsRenderer({
            map: this.settings.map, 
            suppressMarkers: true, 
            polylineOptions: {
              strokeColor: "#a61aad",
              strokeWeight: 8,
              strokeOpacity: opacity
            },
            preserveViewport: true
          }); // (to ensure zoom is respected) preserveViewport: true

          this.settings.directionsDisplay.setMap(this.settings.map);
          this.calcRoute(false, true); // calculate the current route
        },


        // Set up the route.
        calcRoute: function(reset, last) {
          var reset = (reset) ? true : false;
          var last  = (last)  ? true : false;
          
          // Start at the west side
          var start = this.settings.orig_start = new google.maps.LatLng(38.966176, -77.430888); // cont to Dulles Greenway
          var end   = this.settings.orig_end   = new google.maps.LatLng(38.931673, -77.212148); // cont. to 267
          
          // If last is true, we are loading the route of the last request (re-creating it)
          var posStart = (!last) ? this.settings.start : this.settings.lastStart;
          var posEnd   = (!last) ? this.settings.end   : this.settings.lastEnd;
          
          // Get start position - mind the reset
          if (this.testPoint('start', last) && this.testPoint('end', last) && !reset) {
            if (this.settings.heading == 'east') { // east bound
              // The route maps fine this way :)
              start = new google.maps.LatLng(posStart.getPosition().lat(), posStart.getPosition().lng());
              end   = new google.maps.LatLng(posEnd.getPosition().lat(), posEnd.getPosition().lng());
            }
            else { // west bound
              // When headed west, the directions need to be reversed to keep the route on the right path
              //  If and when we handle the east and west bound traffic differently (adding new route markers etc.) this 
              //  can be updated (and or removed)
              end   = new google.maps.LatLng(posStart.getPosition().lat(), posStart.getPosition().lng()); // note the start is sent into end 
              start = new google.maps.LatLng(posEnd.getPosition().lat(), posEnd.getPosition().lng());     //  and vs. versus.
            }
          }

          // Build request object to send to google
          var request = {
            origin: start,
            destination: end,
            travelMode: google.maps.TravelMode.DRIVING
          };

          var tollCalc = this;
          this.settings.directionsService.route(request, function(result, status) {
            if (status == google.maps.DirectionsStatus.OK) {
              tollCalc.settings.directionsDisplay.setDirections(result);
            }
          });
        },


        // Set the user's proposed heading
        setHeading: function() {
          if (this.settings.start.labelNo > this.settings.end.labelNo) { // east bound
            this.settings.heading = 'east';
          }
          else {
            this.settings.heading = 'west';
          }
        },


        // Ensure the route selected is a valid one.
        verifyRoute: function() {
          var start = this.settings.start;
          var end   = this.settings.end;
          var msgs  = [];

          // Set the heading given the endpoint (marker)
          this.setHeading();

          // I want to print starting point messages
          //  before printing ending point messages.
          
          // Starting point msgs
          if (this.settings.heading === 'east') { // East
            // Nothing to see here... move along.
          }
          if (this.settings.heading === 'west') { // East
            if (start.labelNo == 4) {
              msgs.push('No entry Westbound at '+start.labelContent);
            }
          }
          
          // Ending point msgs
          if (this.settings.heading === 'east') { // East
            if (end.labelNo == 4) {
              msgs.push('No exit Eastbound at '+end.labelContent);
            }
          }
          if (this.settings.heading === 'west') { // East
            if (end.labelNo == 9) { // Monroe
              msgs.push('No exit Westbound at '+end.labelContent);
            }
          }

          if (this.settings.start.labelNo === this.settings.end.labelNo) {
            msgs.push('Cannot end route at starting point');
          }

          if (msgs.length) {
            this.resetMap();
            this.settings.messages = msgs;
            this.updateMessages();
            return false;
          }

          return true;
        },


        // Update warning messages
        updateMessages: function(reset) {
          var reset = (reset) ? true : false;
          if (!reset) { // don't reset
            var content = '';
            var wrapper = (this.settings.messages.length > 1) ? 'li' : 'div';

            // Determine wrapper
            if (this.settings.messages.length > 1) {
              wrapper = 'li';
              content += '<ul>';
            }
            else {
              wrapper = 'div';
            }

            // Add messages to the content
            for (var i in this.settings.messages) {
              content += '<'+wrapper+' class="message">'+this.settings.messages[i]+'</'+wrapper+'>';
            }

            if (this.settings.messages.length > 1) content += '</ul>'; // close the ul
            this.settings.messageCont.html(content).show(); // add messages to screen and show them
          }
          else { // reset msgs
            this.settings.messageCont.html('').hide();
          }
        },

      
        // Set a point for the route
        setPoint: function(pos, marker) {
          marker = this.settings.markers[marker];

          if (!this.testPoint('start') && !this.testPoint('end')) {
            this.resetMarkers();
            this.updateMessages(true);   
          }

          // Set start point
          if (pos == 'start') {
            if (!this.testPoint('end')) this.resetMarkers(); // are they updating the start point
            $('.map-info select.start option[value="'+marker.labelID+'"]').prop('selected', 'selected');
            this.settings.start = marker; // we need to remember the start for calcRoute later
            this.selectMarker(this.settings.start);  // Update label
            
            // In the case that the user is resetting their start point but keeping the end point
            if (this.testPoint('end', true)) {
              this.settings.end = this.settings.lastEnd;
              this.selectMarker(this.settings.end);  // Update label
            }
          }

          // Set end point
          else {
            if (!this.testPoint('start')) this.resetMarkers(); // are they updating the end point
            $('.map-info select.end option[value="'+marker.labelID+'"]').prop('selected', 'selected');
            this.settings.end = marker; // we need to remember the end for calcRoute later
            this.selectMarker(tollCalc.settings.end);  // Update label
            
            // In the case that the user is resetting their end point but keeping the start point
            if (this.testPoint('start', true)) {
              this.settings.start = this.settings.lastStart;
              this.selectMarker(this.settings.start);  // Update label
            }
          }

          if (this.testPoint('start') && this.testPoint('end')) {
            if (this.verifyRoute()) { // Does the route make sense?
              this.calcRoute();          // calculate new route path
              this.saveRoute();          // Save the route in prep for new one
              this.calcToll();           // calculate the toll fee - uses last known route
              this.updateMessages(true); // clear any stray messages
            }     
          }
          this.settings.infoWindows[marker.labelID].close();
        },


        // Saves the route for later use and clears the current route
        saveRoute: function() {
          this.settings.lastStart = this.settings.start;
          this.settings.lastEnd   = this.settings.end;
          this.settings.start     = {};
          this.settings.end       = {};  
        },


        // Initialize the info windows with route declaration buttons
        initInfoWindows: function() {
          //console.log(this.settings.markers);
          var markers = this.settings.markers;
          var exitMarkup = function (labelID) {
            return '<div class="marker-window">\
                      <h5>Is this your starting point or end point?</h5>\
                      <button type="button" class="btn btn-primary" onclick="tollCalc.setPoint(\'start\', \''+labelID+'\')">Start</button>\
                      <button type="button" class="btn btn-danger" onclick="tollCalc.setPoint(\'end\', \''+labelID+'\')">End</button>\
                    </div>';
          };
          var mainMarkup = '<div class="marker-window">\
                              <h5>Main Line Toll Plaza</h5>\
                              <p>Main Line Toll Plaza is not an exit.</p>';
          for (var i in markers) {
            if (markers[i].labelID != 'marker_main') {
              this.settings.infoWindows[markers[i].labelID] = new google.maps.InfoWindow({
                content: exitMarkup(markers[i].labelID)
              });
            }
            else {
              this.settings.infoWindows[markers[i].labelID] = new google.maps.InfoWindow({
                content: mainMarkup
              });
            }
          }
        },


        // Test for presence of start or end points
        // point: (start | end), last (true | false)
        testPoint: function(point, last) {
          last = (last) ? true : false;
          if (point === 'start') {
            if (!last) return this.settings.start.hasOwnProperty('position');
            return this.settings.lastStart.hasOwnProperty('position');
          }
          if (point === 'end') {
            if (!last) return this.settings.end.hasOwnProperty('position');
            return this.settings.lastEnd.hasOwnProperty('position');
          }
        },


        // Add various event handling
        initEvents: function() {
          var markerImgs  = this.getMarkerImgs();
          var markers     = this.settings.markers; 
          var tollCalc    = this;  // remember this forever!
         
          for (var i in markers) {
            // Handle click of marker
            google.maps.event.addListener(markers[i], "click", function (e) {
              // Close any open windows
              for (var i in tollCalc.settings.infoWindows) {
                tollCalc.settings.infoWindows[i].close();
              }
              // Open requested window
              tollCalc.settings.infoWindows[this.labelID].open(tollCalc.settings.map, this);
            });

            // Handle hover of marker
            google.maps.event.addListener(markers[i], 'mouseover', function() {
              if (this.labelID === 'dulles_greenway') {
                this.setIcon(markerImgs['left_hover']);
              }
              else if (this.labelID === 'i267') {
                this.setIcon(markerImgs['right_hover']);
              }
              else {
                if (this.labelID != 'marker_main') {
                  this.setIcon(markerImgs['hover']);
                } 
              }
            });
            google.maps.event.addListener(markers[i], 'mouseout', function() {
              // Don't reset main toll plaza marker, or any marker that is selected as part
              //  of the user's expected route
              if (this.labelID != 'marker_main' && (this.labelClass.search('selected') < 0)) {
                this.setIcon(markerImgs['default']);
              }
              if (this.labelID == 'dulles_greenway' && (this.labelClass.search('selected') < 0)) {
                this.setIcon(markerImgs['left']);
              }
              if (this.labelID == 'i267' && (this.labelClass.search('selected') < 0)) {
                this.setIcon(markerImgs['right']);
              }
            });
          }
        },


        // Calculate the driver's toll
        calcToll: function() {
          var heading = this.settings.heading;       // Users heading (E/W)
          var startNo = this.settings.lastStart.labelNo; // The users entry point
          var endNo   = this.settings.lastEnd.labelNo;   // The point that they are exiting at
          var toll    = 0;                           // cumulative toll fee

          // here we use the # of axles to select price from tollMap
          var axles = Number(this.settings.axleSelect.find('option:selected').val()) - 2; 

          // Get the toll price map (based on # axles)
          var tollMap = this.tollMap();
          
          // Do they pass through main toll plaza? - EB || WB
          if ((startNo >= 3 && endNo < 3) || (startNo <= 2 && endNo > 2)) {
            toll += tollMap['main'][axles];
          }

          // Heading --East--
          if (heading == 'east') {
            // Entry points w/out tolls
            if (startNo != 3 && startNo != 4) { // No entry toll on Wolftrap or Leesburg
              toll += tollMap[startNo][axles];
            }
            if (endNo != 9) { // No exit toll at Monroe
              toll += tollMap[endNo][axles];
            }
          }

          // Heading --West--
          if (heading == 'west') {
            // Entry points w/out tolls
            if (startNo != 3 && startNo != 9) { // No entry toll on Wolftrap or Monroe
              toll += tollMap[startNo][axles];
            }
            if (endNo != 3 && endNo != 4) { // No exit toll on Wolftrap or Leesburg
              toll += tollMap[endNo][axles];
            }
          }

          toll = Number(toll).toFixed(2);             // covert toll to decimal w 2 digits
          this.settings.tollText.html('<span>$'+toll+'</span>');      // set toll in window
        },


        // Get toll mapping according to # axles
        //  Maps to axle count (2, 3, 4, 5, 6) fee
        //  tollMap obj Keyed by settings.(start/end point).LabelNo
        tollMap: function(dir) {
          var tollMap = {};
          tollMap[12] = [0, 0, 0,   0, 0];   // Dulles Greenway
          tollMap[11] = [1, 2, 2.5, 3, 3.5]; // Sully road
          tollMap[10] = [1, 2, 2.5, 3, 3.5]; // Centerville
          tollMap[9]  = [1, 2, 2.5, 3, 3.5]; // Monroe
          tollMap[8]  = [1, 2, 2.5, 3, 3.5]; // Fairfax
          tollMap[7]  = [1, 2, 2.5, 3, 3.5]; // Reston
          tollMap[6]  = [1, 2, 2.5, 3, 3.5]; // Wiehle
          tollMap[5]  = [1, 2, 2.5, 3, 3.5]; // Huntermill
          tollMap[4]  = [0, 0, 0,   0, 0];   // Wolftrap
          tollMap[3]  = [1, 2, 2.5, 3, 3.5]; // Leesburg
          tollMap[2]  = [1, 2, 2.5, 3, 3.5]; // Springhill
          tollMap[1]  = [0, 0, 0,   0, 0];   // On to 267
          
          // Main toll plaza
          tollMap['main'] = [2.5, 5, 6.25, 7.5, 8.75]; // Not an exit or entrance 
          return tollMap;
        },


        // Update the marker class
        selectMarker: function(marker) {
          var markerImgs = this.getMarkerImgs();
          marker.set('labelClass', marker.labelClass+' selected');
          if (marker.labelID === 'dulles_greenway') {
            marker.setIcon(markerImgs['left_hover']);
          }
          else if (marker.labelID === 'i267') {
            marker.setIcon(markerImgs['right_hover']);
          }
          else {
            marker.setIcon(markerImgs['hover']);
          }
        },


        // Reset markers as needed
        resetMarkers: function() {
          var markerImgs = this.getMarkerImgs();
          for (var i in this.settings.markers) {
            if (this.settings.markers[i].labelID != 'marker_main') {
              // remove selected class
              if (this.settings.markers[i].labelClass.search('selected') > 0) {
                this.settings.markers[i].set('labelClass', this.settings.markers[i].labelClass.slice(0, -9));
              }
              
              // Reset markers
              if (this.settings.markers[i].labelID === 'dulles_greenway') {
                this.settings.markers[i].setIcon(markerImgs['left']);
              }
              else if (this.settings.markers[i].labelID === 'i267') {
                this.settings.markers[i].setIcon(markerImgs['right']);
              }
              else {
                this.settings.markers[i].setIcon(markerImgs['default']);
              }       
            }
          }
          this.calcRoute(true); // Passing true resets the route (full length route line appears)
        },


        // Return an object of all marker images
        getMarkerImgs: function() {
          var markerImgs = {};
          markerImgs['default'] = {
            url: 'Marker.png',
            size: new google.maps.Size(20, 20),   // This marker is 20 pixels wide by 20 pixels high.
            origin: new google.maps.Point(0, 0),  // The origin for this image is (0, 0).
            anchor: new google.maps.Point(10, 10) // The anchor for this image is the center the image. 
          };
          markerImgs['hover'] = {
            url: 'MarkerHover.png',
            size: new google.maps.Size(20, 20),   // This marker is 20 pixels wide by 20 pixels high.
            origin: new google.maps.Point(0, 0),  // The origin for this image is (0, 0).
            anchor: new google.maps.Point(10, 10) // The anchor for this image is the center the image.
          };
          markerImgs['main'] = {
            url: 'MarkerMain.png',
            size: new google.maps.Size(13, 20),   // This marker is 20 pixels wide by 20 pixels high.
            origin: new google.maps.Point(0, 0),  // The origin for this image is (0, 0).
            anchor: new google.maps.Point(10, 10) // The anchor for this image is the center the image.
          };
          markerImgs['left'] = {
            url: 'arrow-left.png',
            size: new google.maps.Size(35, 25),   // This marker is 20 pixels wide by 20 pixels high.
            origin: new google.maps.Point(0, 0),  // The origin for this image is (0, 0).
            anchor: new google.maps.Point(15, 12) // The anchor for this image is the center the image.
          };
          markerImgs['right'] = {
            url: 'arrow-right.png',
            size: new google.maps.Size(35, 25),   // This marker is 20 pixels wide by 20 pixels high.
            origin: new google.maps.Point(0, 0),  // The origin for this image is (0, 0).
            anchor: new google.maps.Point(15, 12) // The anchor for this image is the center the image.
          };
          markerImgs['left_hover'] = {
            url: 'arrow-left-hover.png',
            size: new google.maps.Size(35, 25),   // This marker is 20 pixels wide by 20 pixels high.
            origin: new google.maps.Point(0, 0),  // The origin for this image is (0, 0).
            anchor: new google.maps.Point(15, 12) // The anchor for this image is the center the image.
          };
          markerImgs['right_hover'] = {
            url: 'arrow-right-hover.png',
            size: new google.maps.Size(35, 25),   // This marker is 20 pixels wide by 20 pixels high.
            origin: new google.maps.Point(0, 0),  // The origin for this image is (0, 0).
            anchor: new google.maps.Point(15, 12) // The anchor for this image is the center the image.
          };
          return markerImgs;
        },


        // Add all markers to the map
        //  @TODO add arrow endpoint markers
        addMarkers: function() {
          var markers = {};
          var images = this.getMarkerImgs();

          // East to West
          markers['i267'] = new MarkerWithLabel({ // Start
              position: new google.maps.LatLng(38.931673, -77.212148),
              map: this.settings.map,
              icon: images['right'],
              labelNo: 1,
              labelID: 'i267',
              labelContent: 'Interstate 267',
              labelClass: "marker-label bot lbl-start",
              labelInForeground: true,
              labelAnchor: new google.maps.Point(40, -15),
          });
          markers['spring_hill'] = new MarkerWithLabel({ // Spring hill rd exit
              position: new google.maps.LatLng(38.933476, -77.233097),
              map: this.settings.map,
              icon: images['default'],
              labelNo: 2,
              labelID: 'spring_hill',
              labelContent: 'Spring Hill Rd.',
              labelClass: "marker-label top lbl-springhill",
              labelInForeground: true,
              labelAnchor: new google.maps.Point(37, 33),
          });
          markers['marker_main'] = new MarkerWithLabel({ // Main toll plaza
              position: new google.maps.LatLng(38.934199, -77.238835),
              map: this.settings.map,
              icon: images['main'],
              labelID: 'marker_main'
          });
          markers['leesburg_pike'] = new MarkerWithLabel({ // Leesburg Pike exit
              position: new google.maps.LatLng(38.933952, -77.246473),
              map: this.settings.map,
              icon: images['default'],
              labelNo: 3,
              labelID: 'leesburg_pike',
              labelContent: 'Leesburg Pike',
              labelClass: "marker-label bot lbl-leesburg",
              labelInForeground: true,
              labelAnchor: new google.maps.Point(37, -15)
          });
          markers['wolftrap_rd'] = new MarkerWithLabel({ // Wolftrap exit
              position: new google.maps.LatLng(38.936173, -77.267612),
              map: this.settings.map,
              icon: images['default'],
              labelNo: 4,
              labelID: 'wolftrap_rd',
              labelContent: 'Wolftrap Rd.',
              labelClass: "marker-label top lbl-wolftrap",
              labelInForeground: true,
              labelAnchor: new google.maps.Point(33, 33)
          });
          markers['huntermill_rd'] = new MarkerWithLabel({ // Hunter Mill exit
              position: new google.maps.LatLng(38.947480, -77.311970),
              map: this.settings.map,
              icon: images['default'],
              labelNo: 5,
              labelID: 'huntermill_rd',
              labelContent: 'Huntermill Rd.',
              labelClass: "marker-label top lbl-huntermill",
              labelInForeground: true,
              labelAnchor: new google.maps.Point(38, 33)
          });
          markers['wiehle_ave'] = new MarkerWithLabel({ // Wiehle Ave exit
              position: new google.maps.LatLng(38.946697, -77.337822),
              map: this.settings.map,
              icon: images['default'],
              labelNo: 6,
              labelID: 'wiehle_ave',
              labelContent: 'Wiehle Ave.',
              labelClass: "marker-label bot lbl-wiehle",
              labelInForeground: true,
              labelAnchor: new google.maps.Point(32, -15)
          });
          markers['reston_parkway'] = new MarkerWithLabel({ // Reston Parkway exit
              position: new google.maps.LatLng(38.951924, -77.356179),
              map: this.settings.map,
              icon: images['default'],
              labelNo: 7,
              labelID: 'reston_parkway',
              labelContent: 'Reston Parkway',
              labelClass: "marker-label top lbl-reston",
              labelInForeground: true,
              labelAnchor: new google.maps.Point(44, 33)
          });
          markers['fairfax_parkway'] = new MarkerWithLabel({ // Fairfax Parkway exit
              position: new google.maps.LatLng(38.952877, -77.374265),
              map: this.settings.map,
              icon: images['default'],
              labelNo: 8,
              labelID: 'fairfax_parkway',
              labelContent: 'Fairfax Parkway',
              labelClass: "marker-label bot lbl-fairfax",
              labelInForeground: true,
              labelAnchor: new google.maps.Point(41, -15),
          });
          markers['monroe_st'] = new MarkerWithLabel({ // Monroe St. exit
              position: new google.maps.LatLng(38.952984, -77.388808),
              map: this.settings.map,
              icon: images['default'],
              labelNo: 9,
              labelID: 'monroe_st',
              labelContent: 'Monroe St.',
              labelClass: "marker-label top lbl-monroe",
              labelInForeground: true,
              labelAnchor: new google.maps.Point(29, 33)
          });
          markers['centerville_rd'] = new MarkerWithLabel({ // Centerville Rd. exit
              position: new google.maps.LatLng(38.956560, -77.404512),
              map: this.settings.map,
              icon: images['default'],
              labelNo: 10,
              labelID: 'centerville_rd',
              labelContent: 'Centerville Rd.',
              labelClass: "marker-label bot lbl-centerville",
              labelInForeground: true,
              labelAnchor: new google.maps.Point(38, -15)
          });
          markers['sully_rd'] = new MarkerWithLabel({ // Sully Rd. exit
              position: new google.maps.LatLng(38.962125, -77.422574),
              map: this.settings.map,
              icon: images['default'],
              labelNo: 11,
              labelID: 'sully_rd',
              labelContent: 'Sully Rd.',
              labelClass: "marker-label bot lbl-sully",
              labelInForeground: true,
              labelAnchor: new google.maps.Point(24, -15)
          });
          markers['dulles_greenway'] = new MarkerWithLabel({ // On to Dulles Greenway
              position: new google.maps.LatLng(38.966176, -77.430888),
              map: this.settings.map,
              icon: images['left'],
              labelNo: 12,
              labelID: 'dulles_greenway',
              labelContent: 'Dulles Greenway',
              labelClass: "marker-label top lbl-end",
              labelInForeground: true,
              labelAnchor: new google.maps.Point(50, 33)
          });
          
          this.settings.markers = markers;
        },


        // Presently only init's traffic checkbox     
        initCheckboxes: function() {
          var tollCalc = this;
          
          $('.traffic-check').click(function() {
            tollCalc.toggleTraffic($(this).prop("checked"));
            if ($(this).prop("checked")) {
              $(this).parent('label').find('span').text('Disable traffic');
            }
            else {
              $(this).parent('label').find('span').text('Enable traffic');
            }
          });
          
          // User clicks the show map checkbox
          $('.mapshow-check').click(function() {
            if ($(this).prop("checked")) {
              $('#map, #map-info .traffic').css('display', 'block');
              $('#map-info .btn-reset .fm').hide(); // hide form text
              $('#map-info .btn-reset .mp').show(); // show map text

              // Resize and recenter the map since it is now visible to the user
              google.maps.event.trigger(tollCalc.settings.map, 'resize');
              tollCalc.settings.map.setCenter(tollCalc.settings.center);
            }
            else {
              $('#map, #map-info .traffic').css('display', 'none');
              $('#map-info .btn-reset .fm').show(); // show form text
              $('#map-info .btn-reset .mp').hide(); // hide map text
            }
          });
        },


        // Set up change events for the select boxes
        initSelectBoxes: function() {
          var tollCalc = this;
          var valueSelected, optionSelected = '';

          // Start point changed
          this.settings.startSelect.change(function(e) {
            optionSelected = $("option:selected", this);
            valueSelected  = this.value;
            tollCalc.setPoint('start', valueSelected);
          });

          // End point changed
          this.settings.endSelect.change(function(e) {
            optionSelected = $("option:selected", this);
            valueSelected  = this.value;
            tollCalc.setPoint('end', valueSelected);
          });

          // Axle count changed
          this.settings.axleSelect.change(function(e) {
            // Toll calc uses the last points that were set
            if (tollCalc.testPoint('start', true) && tollCalc.testPoint('end', true)) {
              tollCalc.calcToll();
            }
          });
        },


        // Reset map comps
        resetMap: function() {
          this.resetMarkers(); // Reset markers
          this.updateMessages(true); // Reset messages
          
          // Reset start / end select boxes
          this.settings.startSelect.find('option[value="start"]').prop('selected', true);
          this.settings.endSelect.find('option[value="end"]').prop('selected', true);
          
          // Reset toll fee content
          this.settings.tollText.html('');
          
          // Reset all start and end points
          this.settings.start     = {};
          this.settings.end       = {};
          this.settings.lastStart = {};
          this.settings.lastEnd   = {};
          
          // Recenter the map
          this.settings.map.setCenter(this.settings.center);
        },


        // Click event for reset btn
        initBtnReset: function() {
          var tollCalc = this;
          $('.btn-reset').click(function() {
            tollCalc.resetMap();
          });
        }
      };
    </script>
    <script 
      src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBmJ2morRvylFgmS-bcKsCPeklcxJ2lZTg&callback=tollCalc.initialize">
    </script>
  </body>
</html>
